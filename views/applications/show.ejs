<div id="content_body">
    <div id="detailApplication">
        <header>
            <h4 class="name">
                <%= application.name %>
                <% if (user_logged_permissions.includes('2')) { -%>   
                    <a href="/idm/applications/<%= application.id %>/edit/" class="small">
                        <i class="fa fa-edit"></i>
                        <span>edit</span>
                    </a>
                <% } -%>%>
                <% if (user_logged_permissions.includes('3')) { -%>
                    <a href="/idm/applications/<%= application.id %>/edit/roles/" class="small">
                        <i class="fa fa-cogs"></i>
                        <span>manage roles</span>
                    </a>
                <% } -%>%>
            </h4>
            <div class="logo">
                <img alt="application logo" src="<%= application.image %>">
            </div>
        </header>
        <div class="panel panel-default info">
            <div class="panel-body">
                <div class="description">
                    <h5>
                        Description
                    </h5>
                    <div class="info expander">
                        <p>
                        <%  var lines = application.description.split(/\r\n|\r|\n/)%>
                        <% for (var i = 0; i < lines.length; i++) { -%>
                            <% if (lines[i].replace(/^\s+/, '').replace(/\s+$/, '') !== '') { -%>
                                <%= lines[i] %>
                                <br>
                            <% } -%>
                        <% } -%>
                        </p>
                    </div>
                </div>
                <div class="url">
                    <h5>URL</h5>
                    <p><%= application.url %></p>
                </div>
                <div class="callback_url">
                    <h5>Callback URL</h5>
                    <p><%= application.redirect_uri %></p>
                </div>
                <% if (user_logged_permissions.some(r=> ['1', '5', '6'].includes(r))) { -%>
                    <div class="extra">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" href="#collapse_oauth2_credentials" aria-expanded="true" aria-controls="collapse_oauth2_credentials" class="collapsed">
                                OAuth2 Credentials <i class="fa fa-angle-up"></i>
                            </a>
                            <a href="#" class="contextual-help" data-toggle="popover" data-title="OAuth2 Credentials" data-placement="left" data-content="You will be asked for these credentials in the OAuth2 library you use for your application" data-original-title="" title=""><i class="fa fa-question-circle"></i></a>
                        </h4>
                        <div class="collapse_out">
                            <div id="collapse_oauth2_credentials" class="form-group collapse" role="tabpanel">
                                <div>
                                    <h6 class="panel-heading">Client ID</h6>
                                    <p><%= application.id %></p>
                                </div>
                                <div>
                                    <h6 class="panel-heading">Client Secret</h6>
                                    <p><%= application.secret %></p>
                                </div>
                            </div>
                        </div>
                    </div>
                <% } -%>
            </div>
        </div>
        <% if (user_logged_permissions.includes('2')) { -%>
            <div class="panel panel-default info">
                <div class="panel-body">
                    <div class="extra">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" href="#collapse_pep_proxy" aria-expanded="true" aria-controls="collapse_pep_proxy" class="collapsed">
                                PEP Proxy <i class="fa fa-angle-up"></i>
                            </a>
                            <a href="#" class="contextual-help" data-toggle="popover" data-title="PEP Proxy" data-placement="left" data-content="A PEP Proxy, along with an Authorization PDP, will let you add authentication and authorization security to your application. This way, you will be able also to manage specific permissions and policies to your resources, allowing different access levels to your users." data-original-title="" title=""><i class="fa fa-question-circle"></i></a>
                        </h4>
                        <div id="collapse_pep_proxy" class="form-group collapse " role="tabpanel">
                            <% if (pep_proxy) { -%>
                                <div class="row content_pep">
                                    <div class="col-md-8 user_pep">
                                        <h6 class="panel-heading">Application Id</h6>
                                        <p><%= application.id%></p>
                                    </div>
                                </div>
                                <div class="row content_pep">
                                    <div class="col-md-8 user_pep">
                                        <h6 class="panel-heading">Pep Proxy Username</h6>
                                        <p><%= pep_proxy.id%></p>
                                    </div>
                                    <div class="col-md-4 actions_pep">
                                        <br>
                                        <a href="/idm/applications/<%= application.id %>/pep/<%= pep_proxy.id%>/reset_password" class="btn btn-default reset_password">Reset password</a>
                                        <a href="/idm/applications/<%= application.id %>/pep/<%= pep_proxy.id%>/delete" class="btn btn-danger delete_pep">
                                            <i class="fa fa-trash"></i> Delete
                                        </a>
                                    </div>
                                </div>
                            <% } else { -%>
                                <h6 class="panel-heading"></h6>
                                <a id="register_pep" href="/idm/applications/<%= application.id %>/pep/register/" class="btn btn-default">Register a new PEP Proxy</a>            
                            <% } -%>
                        </div>
                    </div>
                </div>
            </div>
        <% } -%>
        <% if (user_logged_permissions.includes('2')) { -%>
            <div class="panel panel-default info">
                <div class="panel-body">
                    <div class="extra">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" href="#collapse_iot_sensors" aria-expanded="true" aria-controls="collapse_iot_sensors" class="collapsed">
                                IoT Sensors <i class="fa fa-angle-up"></i>
                            </a>
                            <a href="#" class="contextual-help" data-toggle="popover" data-title="IoT Sensors" data-placement="left" data-content="If your application is related to IoT, sensors need to be registered here for them to be authenticated." data-original-title="" title=""><i class="fa fa-question-circle"></i></a>
                        </h4>
                        <div id="collapse_iot_sensors" class="form-group collapse  no-transition" role="tabpanel">
                            <% if (iot_sensors.length > 0) { -%>
                                <% for (var i = 0; i < iot_sensors.length; i++) { -%>
                                    <div class="row content_iot">
                                        <div class="col-md-8 user_iot">
                                            <h6 class="panel-heading">Id of Sensor <%= i+1%></h6>
                                            <p><%= iot_sensors[i].id%></p>
                                        </div>
                                        <div class="col-md-4 actions_iot">
                                            <br>
                                            <a href="/idm/applications/<%= application.id %>/iot/<%= iot_sensors[i].id%>/reset_password" class="btn btn-default  reset_password">Reset password</a>
                                            <a href="/idm/applications/<%= application.id %>/iot/<%= iot_sensors[i].id%>/delete" class="btn btn-danger delete_iot">
                                                <i class="fa fa-trash"></i> Delete
                                            </a>
                                        </div>
                                    </div>
                                <% } -%>
                            <% } -%>
                            <h6 class="panel-heading"></h6>
                            <a id="register_iot" href="/idm/applications/<%= application.id %>/iot/register/" class="btn btn-default">Register a new IoT Sensor</a>
                        </div>
                    </div>
                </div>
            </div>
        <% } -%>

        <div class="panel panel-default datatable" id="trust_apps" data-pagination-url="/filters/applications" data-application_id="<%= application.id %>" data-pagination-pages="">
            <div class="panel-heading">
                <span class="title">Trusted Applications</span>
                <div class="table_actions clearfix">
                    <div class="filter table_search client">
                        <input class="form-control" value="" type="text" name="trust_apps__filter__q" placeholder="Filter">
                    </div>
                    <div id="spinner_trust_apps" class="filtering-spinner-inline" style="display: none;"><i class="fa fa-circle-o-notch fa-spin"></i></div>                    
                    <% if (user_logged_permissions.some(r=> ['1', '5', '6'].includes(r))) { -%>
                        <div class="btn-group"> 
                            <button title="Add" class="btn btn-default btn-sm ajax-modal" data-toggle="modal" data-target="#add_trusted_app" id="add_trusted_app_button">
                                <i class="fa fa-plus"></i> 
                                <span class="action">
                                    Add
                                </span>
                            </button>
                        </div>
                    <% } -%>
                </div>
            </div>
            <div class="panel-body datatable-content">
                <div id="trust_apps_content" class="list-group">
                    <p class="alert alert-info empty" style="display: none;">This application does not have any trusted application.</p>
                </div>
            </div>
            <div class="panel-footer">
                <nav id="trust_apps_pagination_container"></nav>
            </div>
        </div>

        <div class="panel panel-default datatable" id="auth_users" data-pagination-url="/filters/users" data-application_id="<%= application.id %>" data-pagination-pages="">
            <div class="panel-heading">
                <span class="title">Authorized Users</span>
                <div class="table_actions clearfix">
                    <div class="filter table_search client">
                        <input class="form-control" value="" type="text" name="auth_users__filter__q" placeholder="Filter">
                    </div>
                    <div id="spinner_auth_users" class="filtering-spinner-inline" style="display: none;"><i class="fa fa-circle-o-notch fa-spin"></i></div>                    
                    <% if (user_logged_permissions.some(r=> ['1', '5', '6'].includes(r))) { -%>
                        <div class="btn-group"> 
                            <button title="Authorize" class="btn btn-default btn-sm ajax-modal" data-toggle="modal" data-target="#authorize_user" id="auth_users_action_manage_application_users">
                                <i class="fa fa-key"></i> 
                                <span class="action">
                                    Authorize
                                </span>
                            </button>
                        </div>
                    <% } -%>
                </div>
            </div>
            <div class="panel-body datatable-content">
                <div id="auth_users_content" class="list-group">
                    <p class="alert alert-info empty" style="display: none;">No users found.</p>
                </div>
            </div>
            <div class="panel-footer">
                <nav id="auth_users_pagination_container"></nav>
            </div>
        </div>

        <div class="panel panel-default datatable" id="auth_organizations" data-pagination-url="/filters/organizations" data-application_id="<%= application.id %>" data-pagination-pages="">
            <div class="panel-heading">
                <span class="title">Authorized Organizations</span>
                <div class="table_actions clearfix">
                    <div class="filter table_search client">
                        <input class="form-control" value="" type="text" name="organizations__filter__q" placeholder="Filter">
                    </div>
                    <div id="spinner_organizations" class="filtering-spinner-inline" style="display: none;"><i class="fa fa-circle-o-notch fa-spin"></i></div>
                    <% if (user_logged_permissions.some(r=> ['1', '5', '6'].includes(r))) { -%>
                        <div class="btn-group"> 
                            <button title="Authorize" data-toggle="modal" data-target="#authorize_organization" class="btn btn-default btn-sm ajax-modal" id="auth_organizations_action_manage_application_organizations">
                                <i class="fa fa-key"></i> 
                                <span class="action">
                                    Authorize
                                </span>
                            </button>
                        </div>
                    <% } -%>
                </div>
            </div>
            <div class="panel-body datatable-content">
                <div id="auth_organizations_content" class="list-group">
                    <p class="alert alert-info empty" style="display: none;">This application does not have any authorized organizations.</p>                    
                </div>
            </div>
            <div class="panel-footer">
                <nav id="auth_organizations_pagination_container"></nav>
            </div>
        </div>

    </div>
</div>

<%- include _authorize_user %>
<%- include _authorize_organization %>
<%- include _add_trusted_application %>
<%- include ../templates/./applications/./_pep_proxy_row %>
<%- include ../templates/./applications/./_iot_row %>
<%- include ../templates/./applications/./_application_row %>
<%- include ../templates/./applications/./_trusted_application_row %>
<%- include ../templates/./applications/./_available_application_row %>
<%- include ../templates/./users/./_available_user_row %>
<%- include ../templates/./users/./_assign_role_user_row %>
<%- include ../templates/./users/./_user_row %>
<%- include ../templates/./other/./_info_message %>
<%- include ../templates/./organizations/./_organization_row %>
<%- include ../templates/./organizations/./_assign_role_organization_row %>
<%- include ../templates/./organizations/./_available_organization_row %>

<div class="messages"></div>
<script src="/javascripts/users/search_available_users.js" type="text/javascript"></script>
<script src="/javascripts/applications/search_available_applications.js" type="text/javascript"></script>
<script src="/javascripts/organizations/search_available_organizations.js" type="text/javascript"></script>
<script src="/javascripts/applications/handle_iot.js" type="text/javascript"></script>
<script src="/javascripts/applications/handle_pep_proxy.js" type="text/javascript"></script>
<script src="/javascripts/applications/handle_get_authorized_users.js" type="text/javascript"></script>
<script src="/javascripts/applications/handle_get_authorized_organizations.js" type="text/javascript"></script>
<script src="/javascripts/applications/handle_authorize_users.js" type="text/javascript"></script>
<script src="/javascripts/applications/handle_authorize_organizations.js" type="text/javascript"></script>
<script src="/javascripts/applications/handle_get_trusted_applications.js" type="text/javascript"></script>
<script src="/javascripts/applications/handle_add_trusted_applications.js" type="text/javascript"></script>

<script type="text/javascript">
    $('.panel-title a:first-child').mouseover(function(){
        $(this).children().toggleClass('fa-rotate-180');
    });
    $('.panel-title a:first-child').mouseleave(function(){
        if ($(this).hasClass('collapsed')){
            $(this).children().removeClass('fa-rotate-180');
        } else {
            $(this).children().addClass('fa-rotate-180');
        }
    });
    $('.panel-title a:first-child').click(function(){
        if ($(this).hasClass('collapsed')){
            $(this).children().addClass('fa-rotate-180');
        } else {
            $(this).children().removeClass('fa-rotate-180');
        }
    });
</script>

<script type="text/javascript">
    $(function () {
        $('[data-toggle="popover"]').popover({html:true});
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>
